name: Update clone badges (metrics branch)

on:
  # Run once per day.
  # Note: GitHub cron runs in UTC.
  schedule:
    - cron: "25 3 * * *"
  # Allow manual runs from the Actions tab.
  workflow_dispatch:

# We need permission to push commits into the repository (metrics branch).
permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # Checkout the "metrics" branch (where we store generated JSON files),
      # so main branch stays clean.
      - name: Checkout metrics branch
        uses: actions/checkout@v4
        with:
          ref: metrics

      # jq is a command-line JSON processor.
      # We use it to extract values from GitHub API responses.
      - name: Install jq (JSON parser)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Collect GitHub traffic clones (unique clones, last 14 days)
        env:
          # Fine-grained PAT stored in repo secrets.
          GH_TOKEN: ${{ secrets.TRAFFIC_TOKEN }}
          OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail

          echo "Fetching list of public repositories for $OWNER..."

          # 1) List all public repos for the user (max 100).
          # If you ever have >100 public repos, we can add pagination.
          repos_json=$(curl -sS \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/users/$OWNER/repos?per_page=100&type=public")

          # 2) Exclude the profile repo OWNER/OWNER (e.g., Cometores/Cometores),
          # because it can distort stats and is not a "real project repo".
          repos=$(echo "$repos_json" | jq -r '.[] | select(.name != env.OWNER) | .name')

          total_uniques=0
          top_repo=""
          top_uniques=-1

          # We'll store per-repo stats to a JSON file for future extension.
          by_repo="[]"

          echo "Calculating unique clones per repo (last 14 days window)..."

          for r in $repos; do
            echo "  -> $r"

            # 3) Query traffic clones for each repo.
            # GitHub returns:
            #   { count: <total clones>, uniques: <unique cloners>, clones: [...] }
            resp=$(curl -sS \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$OWNER/$r/traffic/clones")

            uniques=$(echo "$resp" | jq -r '.uniques // 0')
            count=$(echo "$resp"  | jq -r '.count // 0')

            total_uniques=$((total_uniques + uniques))

            # Track the top repo by uniques
            if [ "$uniques" -gt "$top_uniques" ]; then
              top_uniques=$uniques
              top_repo=$r
            fi

            # Append to by_repo array
            by_repo=$(echo "$by_repo" | jq \
              --arg repo "$r" \
              --argjson u "$uniques" \
              --argjson c "$count" \
              '. + [{"repo": $repo, "uniques": $u, "count": $c}]')
          done

          # Sort repos by uniques descending
          by_repo_sorted=$(echo "$by_repo" | jq 'sort_by(.uniques) | reverse')

          # 4) Create output directories on the metrics branch
          mkdir -p badges stats

          # 5) Write Shields-compatible JSON files.
          # These files are then read by shields.io to render badges in README.
          jq -n --arg msg "$total_uniques" \
            '{schemaVersion:1,label:"unique clones (14d)",message:$msg,color:"blue"}' \
            > badges/clones-total.json

          top_msg="${top_repo}: ${top_uniques}"
          jq -n --arg msg "$top_msg" \
            '{schemaVersion:1,label:"top repo (14d)",message:$msg,color:"blue"}' \
            > badges/clones-top.json

          # Extra: store full per-repo list (useful later for tables, charts, etc.)
          echo "$by_repo_sorted" > stats/clones-by-repo.json

          echo "Done. Total uniques: $total_uniques. Top repo: $top_repo ($top_uniques)."

      # Commit changes only if files changed.
      - name: Commit & push to metrics branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add badges/*.json stats/*.json
          git commit -m "Update clone stats" || exit 0
          git push origin metrics
